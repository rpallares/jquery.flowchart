$(function(){$.widget("flowchart.flowchart",{options:{canUserEditLinks:!0,canUserMoveOperators:!0,data:{},distanceFromArrow:3,defaultOperatorClass:"flowchart-default-operator",defaultLinkColor:"#3366ff",defaultSelectedLinkColor:"black",linkWidth:10,grid:20,multipleLinksOnOutput:!1,multipleLinksOnInput:!1,linkVerticalDecal:0,onOperatorSelect:function(a){return!0},onOperatorUnselect:function(){return!0},onLinkSelect:function(a){return!0},onLinkUnselect:function(){return!0},onOperatorCreate:function(a,b,c){return!0},onLinkCreate:function(a,b){return!0},onOperatorDelete:function(a){return!0},onLinkDelete:function(a,b){return!0},onOperatorMoved:function(a,b){},onAfterChange:function(a){}},data:null,objs:null,maskNum:0,linkNum:0,operatorNum:0,lastOutputConnectorClicked:null,selectedOperatorId:null,selectedLinkId:null,positionRatio:1,globalId:null,_create:function(){"undefined"==typeof document.__flowchartNumber?document.__flowchartNumber=0:document.__flowchartNumber++,this.globalId=document.__flowchartNumber,this._unitVariables(),this.element.addClass("flowchart-container"),this.objs.layers.links=$('<svg class="flowchart-links-layer"></svg>'),this.objs.layers.links.appendTo(this.element),this.objs.layers.operators=$('<div class="flowchart-operators-layer unselectable"></div>'),this.objs.layers.operators.appendTo(this.element),this.objs.layers.temporaryLink=$('<svg class="flowchart-temporary-link-layer"></svg>'),this.objs.layers.temporaryLink.appendTo(this.element);var a=document.createElementNS("http://www.w3.org/2000/svg","line");a.setAttribute("x1","0"),a.setAttribute("y1","0"),a.setAttribute("x2","0"),a.setAttribute("y2","0"),a.setAttribute("stroke-dasharray","6,6"),a.setAttribute("stroke-width","4"),a.setAttribute("stroke","black"),a.setAttribute("fill","none"),this.objs.layers.temporaryLink[0].appendChild(a),this.objs.temporaryLink=a,this._initEvents(),"undefined"!=typeof this.options.data&&this.setData(this.options.data)},_unitVariables:function(){this.data={operators:{},links:{}},this.objs={layers:{operators:null,temporaryLink:null,links:null},linksContext:null,temporaryLink:null}},_initEvents:function(){var a=this;this.element.mousemove(function(b){var c=$(this),d=c.offset();a._mousemove((b.pageX-d.left)/a.positionRatio,(b.pageY-d.top)/a.positionRatio,b)}),this.element.click(function(b){var c=$(this),d=c.offset();a._click((b.pageX-d.left)/a.positionRatio,(b.pageY-d.top)/a.positionRatio,b)}),this.objs.layers.operators.on("mousedown touchstart",".flowchart-operator",function(a){a.stopImmediatePropagation()}),this.objs.layers.operators.on("click",".flowchart-operator",function(b){0==$(b.target).closest(".flowchart-operator-connector").length&&a.selectOperator($(this).data("operator_id"))}),this.objs.layers.operators.on("click",".flowchart-operator-connector",function(){var b=$(this);a.options.canUserEditLinks&&a._connectorClicked(b.closest(".flowchart-operator").data("operator_id"),b.data("connector"),b.data("sub_connector"),b.closest(".flowchart-operator-connector-set").data("connector_type"))}),this.objs.layers.links.on("mousedown touchstart",".flowchart-link",function(a){a.stopImmediatePropagation()}),this.objs.layers.links.on("mouseover",".flowchart-link",function(){a._connecterMouseOver($(this).data("link_id"))}),this.objs.layers.links.on("mouseout",".flowchart-link",function(){a._connecterMouseOut($(this).data("link_id"))}),this.objs.layers.links.on("click",".flowchart-link",function(){a.selectLink($(this).data("link_id"))})},setData:function(a){this._clearOperatorsLayer(),this.data.operatorTypes={},"undefined"!=typeof a.operatorTypes&&(this.data.operatorTypes=a.operatorTypes),this.data.linkRestrictions=[],"undefined"!=typeof a.linkRestrictions&&a.linkRestrictions.length>0&&(this.data.linkRestrictions=a.linkRestrictions),this.data.operators={};for(var b in a.operators)this.createOperator(b,a.operators[b]);for(var c in a.links)this.createLink(c,a.links[c]);this.redrawLinksLayer()},addLink:function(a){for(;"undefined"!=typeof this.data.links[this.linkNum];)this.linkNum++;return this.createLink(this.linkNum,a),this.linkNum},createLink:function(a,b){var c=$.extend(!0,{},b);if(this.options.onLinkCreate(a,c)){var d=this._indexOfLinkGranted(c);if(d!=-1){var e=this._getSubConnectors(c),f=e[0],g=e[1],h=this.options.multipleLinksOnOutput,i=this.options.multipleLinksOnInput;if(!h||!i)for(var j in this.data.links){var k=this.data.links[j],l=this._getSubConnectors(k),m=l[0],n=l[1];h||k.fromOperator!=c.fromOperator||k.fromConnector!=c.fromConnector||m!=f?i||k.toOperator!=c.toOperator||k.toConnector!=c.toConnector||n!=g||this.deleteLink(j):this.deleteLink(j)}if(this._autoCreateSubConnector(c.fromOperator,c.fromConnector,"outputs",f),this._autoCreateSubConnector(c.toOperator,c.toConnector,"inputs",g),null!=d){var o=this.data.linkRestrictions[d];"undefined"!=typeof o.color&&(c.color=o.color)}this.data.links[a]=c,this._drawLink(a),this.options.onAfterChange("link_create")}}},_indexOfLinkGranted:function(a){if(0==this.data.linkRestrictions.length)return null;for(var b=this.data.linkRestrictions,c=0;c<b.length;c++){var d=b[c];if(d.fromOperator==a.fromOperator&&d.fromConnector==a.fromConnector&&d.toOperator==a.toOperator&&d.toConnector==a.toConnector)return c}return-1},_autoCreateSubConnector:function(a,b,c,d){var e=this.data.operators[a].properties[c][b];if(e.multiple)for(var f=this.data.operators[a].internal.els,g=this.data.operators[a].internal.els.connectors[b].length,h=g;h<d+2;h++)this._createSubConnector(b,e,f)},redrawLinksLayer:function(){this._clearLinksLayer();for(var a in this.data.links)this._drawLink(a)},_clearLinksLayer:function(){this.objs.layers.links.empty(),this.objs.layers.operators.find(".flowchart-operator-connector-small-arrow").css("border-left-color","transparent")},_clearOperatorsLayer:function(){this.objs.layers.operators.empty()},getConnectorPosition:function(a,b,c){var d=this.data.operators[a],e=d.internal.els.connectorArrows[b][c],f=e.offset(),g=this.element.offset(),h=(f.left-g.left)/this.positionRatio,i=parseInt(e.css("border-top-width")),j=(f.top-g.top-1)/this.positionRatio+parseInt(e.css("border-left-width"));return{x:h,width:i,y:j}},getLinkMainColor:function(a){var b=this.options.defaultLinkColor,c=this.data.links[a];return"undefined"!=typeof c.color&&(b=c.color),b},setLinkMainColor:function(a,b){this.data.links[a].color=b,this.options.onAfterChange("link_change_main_color")},_drawLink:function(a){var b=this.data.links[a];"undefined"==typeof b.internal&&(b.internal={}),b.internal.els={};var c=b.fromOperator,d=b.fromConnector,e=b.toOperator,f=b.toConnector,g=this._getSubConnectors(b),h=g[0],i=g[1],k=(this.getLinkMainColor(a),this.data.operators[c]),l=this.data.operators[e],m=k.internal.els.connectorSmallArrows[d][h],n=l.internal.els.connectorSmallArrows[f][i];b.internal.els.fromSmallConnector=m,b.internal.els.toSmallConnector=n;var o=document.createElementNS("http://www.w3.org/2000/svg","g");this.objs.layers.links[0].appendChild(o),b.internal.els.overallGroup=o;var p=document.createElementNS("http://www.w3.org/2000/svg","mask"),q="fc_mask_"+this.globalId+"_"+this.maskNum;this.maskNum++,p.setAttribute("id",q),o.appendChild(p);var r=document.createElementNS("http://www.w3.org/2000/svg","rect");r.setAttribute("x","0"),r.setAttribute("y","0"),r.setAttribute("width","100%"),r.setAttribute("height","100%"),r.setAttribute("stroke","none"),r.setAttribute("fill","white"),p.appendChild(r);var r=document.createElementNS("http://www.w3.org/2000/svg","polygon");r.setAttribute("stroke","none"),r.setAttribute("fill","black"),p.appendChild(r),b.internal.els.mask=r;var s=document.createElementNS("http://www.w3.org/2000/svg","g");s.setAttribute("class","flowchart-link"),s.setAttribute("data-link_id",a),o.appendChild(s);var r=document.createElementNS("http://www.w3.org/2000/svg","path");r.setAttribute("stroke-width",this.options.linkWidth),r.setAttribute("fill","none"),s.appendChild(r),b.internal.els.path=r;var r=document.createElementNS("http://www.w3.org/2000/svg","rect");r.setAttribute("stroke","none"),r.setAttribute("mask","url(#"+q+")"),s.appendChild(r),b.internal.els.rect=r,this._refreshLinkPositions(a),this.uncolorizeLink(a)},_getSubConnectors:function(a){var b=0;"undefined"!=typeof a.fromSubConnector&&(b=a.fromSubConnector);var c=0;return"undefined"!=typeof a.toSubConnector&&(c=a.toSubConnector),[b,c]},_refreshLinkPositions:function(a){var b=this.data.links[a],c=this._getSubConnectors(b),d=c[0],e=c[1],f=this.getConnectorPosition(b.fromOperator,b.fromConnector,d),g=this.getConnectorPosition(b.toOperator,b.toConnector,e),h=f.x,i=f.width,j=f.y,k=g.x,l=g.y;j+=this.options.linkVerticalDecal,l+=this.options.linkVerticalDecal;var m=this.options.distanceFromArrow;b.internal.els.mask.setAttribute("points",h+","+(j-i-m)+" "+(h+i+m)+","+j+" "+h+","+(j+i+m));var n=h+i+m,o=k+1,p=Math.min(100,Math.max(Math.abs(n-o)/2,Math.abs(j-l)));b.internal.els.path.setAttribute("d","M"+n+","+j+" C"+(h+i+m+p)+","+j+" "+(k-p)+","+l+" "+o+","+l),b.internal.els.rect.setAttribute("x",h),b.internal.els.rect.setAttribute("y",j-this.options.linkWidth/2),b.internal.els.rect.setAttribute("width",i+m+1),b.internal.els.rect.setAttribute("height",this.options.linkWidth)},getOperatorCompleteData:function(a){"undefined"==typeof a.internal&&(a.internal={}),this._refreshInternalProperties(a),infos=$.extend(!0,{},a.internal.properties);for(var b in infos.inputs)null==infos.inputs[b]&&delete infos.inputs[b];for(var b in infos.outputs)null==infos.outputs[b]&&delete infos.outputs[b];return"undefined"==typeof infos.class&&(infos.class=this.options.defaultOperatorClass),infos},_getOperatorFullElement:function(a){function n(a,b,c,d){var e=$('<div class="flowchart-operator-connector-set"></div>');e.data("connector_type",d),e.appendTo(c),i[a]=[],j[a]=[],l[a]=[],k[a]=e,h._createSubConnector(a,b,m)}var b=this.getOperatorCompleteData(a),c=$('<div class="flowchart-operator"></div>');c.addClass(b.class);var d=$('<div class="flowchart-operator-title"></div>');d.text(b.title),d.appendTo(c);var e=$('<div class="flowchart-operator-inputs-outputs"></div>');e.appendTo(c);var f=$('<div class="flowchart-operator-inputs"></div>');f.appendTo(e);var g=$('<div class="flowchart-operator-outputs"></div>');g.appendTo(e);var h=this,i={},j={},k={},l={},m={operator:c,title:d,connectorSets:k,connectors:l,connectorArrows:i,connectorSmallArrows:j};for(var o in b.inputs)n(o,b.inputs[o],f,"inputs");for(var o in b.outputs)n(o,b.outputs[o],g,"outputs");return m},_createSubConnector:function(a,b,c){var d=c.connectorSets[a],e=c.connectors[a].length,f=$('<div class="flowchart-operator-connector"></div>');f.appendTo(d),f.data("connector",a),f.data("sub_connector",e);var g=$('<div class="flowchart-operator-connector-label"></div>');g.text(b.label.replace("(:i)",e+1)),g.appendTo(f);var h=$('<div class="flowchart-operator-connector-arrow"></div>');h.appendTo(f);var i=$('<div class="flowchart-operator-connector-small-arrow"></div>');i.appendTo(f),c.connectors[a].push(f),c.connectorArrows[a].push(h),c.connectorSmallArrows[a].push(i)},getOperatorElement:function(a){var b=this._getOperatorFullElement(a);return b.operator},addOperator:function(a){for(;"undefined"!=typeof this.data.operators[this.operatorNum];)this.operatorNum++;return this.createOperator(this.operatorNum,a),this.operatorNum},createOperator:function(a,b){function f(a,c){b.top=c.top,b.left=c.left;for(var d in e.data.links){var f=e.data.links[d];f.fromOperator!=a&&f.toOperator!=a||e._refreshLinkPositions(d)}}b.internal={},this._refreshInternalProperties(b);var c=this._getOperatorFullElement(b);if(!this.options.onOperatorCreate(a,b,c))return!1;var d=this.options.grid;b.top=Math.round(b.top/d)*d,b.left=Math.round(b.left/d)*d,c.operator.appendTo(this.objs.layers.operators),c.operator.css({top:b.top,left:b.left}),c.operator.data("operator_id",a),this.data.operators[a]=b,this.data.operators[a].internal.els=c,a==this.selectedOperatorId&&this._addSelectedClass(a);var b=this.data.operators[a],e=this;if(this.options.canUserMoveOperators){var g,h;c.operator.draggable({handle:".flowchart-operator-title",start:function(a,b){if(null!=e.lastOutputConnectorClicked)return void a.preventDefault();var c=e.element.offset();g=(a.pageX-c.left)/e.positionRatio-parseInt($(a.target).css("left")),h=(a.pageY-c.top)/e.positionRatio-parseInt($(a.target).css("top"))},drag:function(a,b){var d=e.options.grid,i=e.element.offset();b.position.left=Math.round(((a.pageX-i.left)/e.positionRatio-g)/d)*d,b.position.top=Math.round(((a.pageY-i.top)/e.positionRatio-h)/d)*d,b.offset.left=Math.round(b.position.left+i.left),b.offset.top=Math.round(b.position.top+i.top),c.operator.css({left:b.position.left,top:b.position.top}),f($(this).data("operator_id"),b.position)},stop:function(a,b){e._unsetTemporaryLink();var d=$(this).data("operator_id");f(d,b.position),c.operator.css({height:"auto"}),e.options.onOperatorMoved(d,b.position),e.options.onAfterChange("operator_moved")}})}this.options.onAfterChange("operator_create")},_connectorClicked:function(a,b,c,d){if("outputs"==d){var e=new Date;e.getTime();this.lastOutputConnectorClicked={operator:a,connector:b,subConnector:c,grantedLinks:this._getGrantedLinks(a,b)},this.objs.layers.temporaryLink.show();var g=this.getConnectorPosition(a,b,c),h=g.x+g.width,i=g.y;this.objs.temporaryLink.setAttribute("x1",h),this.objs.temporaryLink.setAttribute("y1",i),this._mousemove(h,i),this._colorizeGrantedLinks()}if("inputs"==d&&null!=this.lastOutputConnectorClicked){var j={fromOperator:this.lastOutputConnectorClicked.operator,fromConnector:this.lastOutputConnectorClicked.connector,fromSubConnector:this.lastOutputConnectorClicked.subConnector,toOperator:a,toConnector:b,toSubConnector:c};this._unsetTemporaryLink(),this.addLink(j)}},_getGrantedLinks:function(a,b){if(0==this.data.linkRestrictions.length)return[];var c=this.data.linkRestrictions.filter(function(c){return a==c.fromOperator&&b==c.fromConnector}),d=this;return c.map(function(a){"undefined"==typeof a.color&&(a.color=defaultLinkColor);var b=d.data.operators[a.toOperator],c=b.internal.els.connectorSmallArrows[a.toConnector];return a.smallArrows=c.map(function(a){return{els:a,oldColor:a.css("border-left-color")}}),a})},_colorizeGrantedLinks:function(){if(null!=this.lastOutputConnectorClicked){var a=this.lastOutputConnectorClicked.grantedLinks;a.forEach(function(a){a.smallArrows.forEach(function(b){b.els.css("border-left-color",a.color)})})}},_restoreGrantedLinksColor:function(){if(null!=this.lastOutputConnectorClicked){var a=this.lastOutputConnectorClicked.grantedLinks;a.forEach(function(a){a.smallArrows.forEach(function(a){a.els.css("border-left-color",a.oldColor)})})}},_unsetTemporaryLink:function(){this._restoreGrantedLinksColor(),this.lastOutputConnectorClicked=null,this.objs.layers.temporaryLink.hide()},_mousemove:function(a,b,c){null!=this.lastOutputConnectorClicked&&(this.objs.temporaryLink.setAttribute("x2",a),this.objs.temporaryLink.setAttribute("y2",b))},_click:function(a,b,c){var d=$(c.target);0==d.closest(".flowchart-operator-connector").length&&this._unsetTemporaryLink(),0==d.closest(".flowchart-operator").length&&this.unselectOperator(),0==d.closest(".flowchart-link").length&&this.unselectLink()},_removeSelectedClassOperators:function(){this.objs.layers.operators.find(".flowchart-operator").removeClass("selected")},unselectOperator:function(){if(null!=this.selectedOperatorId){if(!this.options.onOperatorUnselect())return;this._removeSelectedClassOperators(),this.selectedOperatorId=null}},_addSelectedClass:function(a){this.data.operators[a].internal.els.operator.addClass("selected")},selectOperator:function(a){this.options.onOperatorSelect(a)&&(this.unselectLink(),this._removeSelectedClassOperators(),this._addSelectedClass(a),this.selectedOperatorId=a)},getSelectedOperatorId:function(){return this.selectedOperatorId},getSelectedLinkId:function(){return this.selectedLinkId},_shadeColor:function(a,b){var c=parseInt(a.slice(1),16),d=b<0?0:255,e=b<0?b*-1:b,f=c>>16,g=c>>8&255,h=255&c;return"#"+(16777216+65536*(Math.round((d-f)*e)+f)+256*(Math.round((d-g)*e)+g)+(Math.round((d-h)*e)+h)).toString(16).slice(1)},colorizeLink:function(a,b){var c=this.data.links[a];c.internal.els.path.setAttribute("stroke",b),c.internal.els.rect.setAttribute("fill",b),c.internal.els.fromSmallConnector.css("border-left-color",b),c.internal.els.toSmallConnector.css("border-left-color",b)},uncolorizeLink:function(a){this.colorizeLink(a,this.getLinkMainColor(a))},_connecterMouseOver:function(a){this.selectedLinkId!=a&&this.colorizeLink(a,this._shadeColor(this.getLinkMainColor(a),-.4))},_connecterMouseOut:function(a){this.selectedLinkId!=a&&this.uncolorizeLink(a)},unselectLink:function(){if(null!=this.selectedLinkId){if(!this.options.onLinkUnselect())return;this.uncolorizeLink(this.selectedLinkId,this.options.defaultSelectedLinkColor),this.selectedLinkId=null}},selectLink:function(a){this.unselectLink(),this.options.onLinkSelect(a)&&(this.unselectOperator(),this.selectedLinkId=a,this.colorizeLink(a,this.options.defaultSelectedLinkColor))},deleteOperator:function(a){this._deleteOperator(a,!1)},_deleteOperator:function(a,b){if(!this.options.onOperatorDelete(a,b))return!1;if(!b)for(var c in this.data.links){var d=this.data.links[c];d.fromOperator!=a&&d.toOperator!=a||this._deleteLink(c,!0)}b||a!=this.selectedOperatorId||this.unselectOperator(),this.data.operators[a].internal.els.operator.remove(),delete this.data.operators[a],this.options.onAfterChange("operator_delete")},deleteLink:function(a){this._deleteLink(a,!1)},_deleteLink:function(a,b){if(this.selectedLinkId==a&&this.unselectLink(),this.options.onLinkDelete(a,b)||b){this.colorizeLink(a,"transparent");var c=this.data.links[a],d=c.fromOperator,e=c.fromConnector,f=c.toOperator,g=c.toConnector;c.internal.els.overallGroup.remove(),delete this.data.links[a],this._cleanMultipleConnectors(d,e,"from"),this._cleanMultipleConnectors(f,g,"to"),this.options.onAfterChange("link_delete")}},_cleanMultipleConnectors:function(a,b,c){if(this.data.operators[a].properties["from"==c?"outputs":"inputs"][b].multiple){var d=-1,e=c+"Operator",f=c+"Connector",g=c+"SubConnector",h=this.data.operators[a].internal.els,i=h.connectors[b],j=i.length;for(var k in this.data.links){var l=this.data.links[k];l[e]==a&&l[f]==b&&d<l[g]&&(d=l[g])}for(var m=Math.min(j-d-2,j-1),n=0;n<m;n++)i[i.length-1].remove(),i.pop(),h.connectorArrows[b].pop(),h.connectorSmallArrows[b].pop()}},deleteSelected:function(){null!=this.selectedLinkId&&this.deleteLink(this.selectedLinkId),null!=this.selectedOperatorId&&this.deleteOperator(this.selectedOperatorId)},setPositionRatio:function(a){this.positionRatio=a},getPositionRatio:function(){return this.positionRatio},getData:function(){var a=["operators","links"],b={};b.operators=$.extend(!0,{},this.data.operators),b.links=$.extend(!0,{},this.data.links);for(var c in a){var d=a[c];for(var e in b[d])delete b[d][e].internal}return b.operatorTypes=this.data.operatorTypes,b},setOperatorTitle:function(a,b){this.data.operators[a].internal.els.title.text(b),"undefined"==typeof this.data.operators[a].properties&&(this.data.operators[a].properties={}),this.data.operators[a].properties.title=b,this._refreshInternalProperties(this.data.operators[a]),this.options.onAfterChange("operator_title_change")},getOperatorTitle:function(a){return this.data.operators[a].internal.properties.title},setOperatorData:function(a,b){var c=this.getOperatorCompleteData(b);for(var d in this.data.links){var e=this.data.links[d];(e.fromOperator==a&&"undefined"==typeof c.outputs[e.fromConnector]||e.toOperator==a&&"undefined"==typeof c.inputs[e.toConnector])&&this._deleteLink(d,!0)}this._deleteOperator(a,!0),this.createOperator(a,b),this.redrawLinksLayer(),this.options.onAfterChange("operator_data_change")},getOperatorData:function(a){var b=$.extend(!0,{},this.data.operators[a]);return delete b.internal,b},getOperatorFullProperties:function(a){if("undefined"!=typeof a.type){var b=this.data.operatorTypes[a.type],c={};return"undefined"!=typeof a.properties&&(c=a.properties),$.extend({},b,c)}return a.properties},_refreshInternalProperties:function(a){a.internal.properties=this.getOperatorFullProperties(a)}})});