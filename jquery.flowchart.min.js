$(function(){$.widget("flowchart.flowchart",{options:{canUserEditLinks:!0,canUserMoveOperators:!0,data:{},distanceFromArrow:3,defaultOperatorClass:"flowchart-default-operator",defaultLinkColor:"#3366ff",defaultSelectedLinkColor:"black",linkWidth:10,grid:20,multipleLinksOnOutput:!1,multipleLinksOnInput:!1,linkVerticalDecal:0,onOperatorSelect:function(){return!0},onOperatorUnselect:function(){return!0},onLinkSelect:function(){return!0},onLinkUnselect:function(){return!0},onOperatorCreate:function(){return!0},onLinkCreate:function(){return!0},onOperatorDelete:function(){return!0},onLinkDelete:function(){return!0},onOperatorMoved:function(){},onAfterChange:function(){}},data:null,objs:null,maskNum:0,linkNum:0,operatorNum:0,lastOutputConnectorClicked:null,selectedOperatorId:null,selectedLinkId:null,positionRatio:1,globalId:null,_create:function(){void 0===document.__flowchartNumber?document.__flowchartNumber=0:document.__flowchartNumber++,this.globalId=document.__flowchartNumber,this._unitVariables(),this.element.addClass("flowchart-container"),this.objs.layers.links=$('<svg class="flowchart-links-layer"></svg>'),this.objs.layers.links.appendTo(this.element),this.objs.layers.operators=$('<div class="flowchart-operators-layer unselectable"></div>'),this.objs.layers.operators.appendTo(this.element),this.objs.layers.temporaryLink=$('<svg class="flowchart-temporary-link-layer"></svg>'),this.objs.layers.temporaryLink.appendTo(this.element);var t=document.createElementNS("http://www.w3.org/2000/svg","line");t.setAttribute("x1","0"),t.setAttribute("y1","0"),t.setAttribute("x2","0"),t.setAttribute("y2","0"),t.setAttribute("stroke-dasharray","6,6"),t.setAttribute("stroke-width","4"),t.setAttribute("stroke","black"),t.setAttribute("fill","none"),this.objs.layers.temporaryLink[0].appendChild(t),this.objs.temporaryLink=t,this._initEvents(),void 0!==this.options.data&&this.setData(this.options.data)},_unitVariables:function(){this.data={operators:{},links:{},linkRestrictions:{}},this.objs={layers:{operators:null,temporaryLink:null,links:null},linksContext:null,temporaryLink:null}},_initEvents:function(){var t=this;this.element.mousemove(function(e){var o=$(this),r=o.offset();t._mousemove((e.pageX-r.left)/t.positionRatio,(e.pageY-r.top)/t.positionRatio,e)}),this.element.click(function(e){var o=$(this),r=o.offset();t._click((e.pageX-r.left)/t.positionRatio,(e.pageY-r.top)/t.positionRatio,e)}),this.objs.layers.operators.on("touchdown mousedown touchstart",".flowchart-operator",function(t){t.stopImmediatePropagation()}),this.objs.layers.operators.on("click",".flowchart-operator",function(e){0==$(e.target).closest(".flowchart-operator-connector").length&&t.selectOperator($(this).data("operator_id"))}),this.objs.layers.operators.on("click",".flowchart-operator-connector",function(){var e=$(this);t.options.canUserEditLinks&&t._connectorClicked(e.closest(".flowchart-operator").data("operator_id"),e.data("connector"),e.data("sub_connector"),e.closest(".flowchart-operator-connector-set").data("connector_type"))}),this.objs.layers.links.on("mousedown touchstart",".flowchart-link",function(t){t.stopImmediatePropagation()}),this.objs.layers.links.on("mouseover",".flowchart-link",function(){t._connecterMouseOver($(this).data("link_id"))}),this.objs.layers.links.on("mouseout",".flowchart-link",function(){t._connecterMouseOut($(this).data("link_id"))}),this.objs.layers.links.on("click",".flowchart-link",function(){t.selectLink($(this).data("link_id"))})},setData:function(t){this._clearOperatorsLayer(),this.data.operatorTypes={},void 0!==t.operatorTypes&&(this.data.operatorTypes=t.operatorTypes),this.data.linkRestrictions=[],void 0!==t.linkRestrictions&&t.linkRestrictions.length>0&&(this.data.linkRestrictions=t.linkRestrictions),this.data.operators={};for(var e in t.operators)t.operators.hasOwnProperty(e)&&this.createOperator(e,t.operators[e]);this.data.links={};for(var o in t.links)t.links.hasOwnProperty(o)&&this.createLink(o,t.links[o]);this.redrawLinksLayer()},addLink:function(t){for(;void 0!==this.data.links[this.linkNum];)this.linkNum++;return this.createLink(this.linkNum,t),this.linkNum},createLink:function(t,e){var o=$.extend(!0,{},e);if(this.options.onLinkCreate(t,o)){var r=this._indexOfLinkGranted(o);if(-1!=r){var n=this._getSubConnectors(o),i=n[0],s=n[1],a=this.options.multipleLinksOnOutput,l=this.options.multipleLinksOnInput;if(!a||!l)for(var c in this.data.links)if(this.data.links.hasOwnProperty(c)){var p=this.data.links[c],h=this._getSubConnectors(p),u=h[0],d=h[1];if(!a&&p.fromOperator==o.fromOperator&&p.fromConnector==o.fromConnector&&u==i){this.deleteLink(c);continue}l||p.toOperator!=o.toOperator||p.toConnector!=o.toConnector||d!=s||this.deleteLink(c)}if(this._autoCreateSubConnector(o.fromOperator,o.fromConnector,"outputs",i),this._autoCreateSubConnector(o.toOperator,o.toConnector,"inputs",s),null!=r){var f=this.data.linkRestrictions[r];void 0!==f.color&&(o.color=f.color)}this.data.links[t]=o,this._drawLink(t),this.options.onAfterChange("link_create")}}},_indexOfLinkGranted:function(t){if(0==this.data.linkRestrictions.length)return null;for(var e=this.data.linkRestrictions,o=0;o<e.length;o++){var r=e[o],n=this.data.operators[t.fromOperator].type,i=this.data.operators[t.toOperator].type;if(r.fromOperatorType==n&&r.fromConnector==t.fromConnector&&r.toOperatorType==i&&r.toConnector==t.toConnector)return o}return-1},_autoCreateSubConnector:function(t,e,o,r){var n=this.data.operators[t].properties[o][e];if(n.multiple)for(var i=this.data.operators[t].internal.els,s=this.data.operators[t].internal.els.connectors[e].length,a=s;r+2>a;a++)this._createSubConnector(e,n,i,o)},redrawLinksLayer:function(){this._clearLinksLayer();for(var t in this.data.links)this.data.links.hasOwnProperty(t)&&this._drawLink(t)},_clearLinksLayer:function(){this.objs.layers.links.empty(),this.objs.layers.operators.find(".flowchart-operator-connector-small-arrow").css("border-left-color","transparent")},_clearOperatorsLayer:function(){this.objs.layers.operators.empty()},getConnectorPosition:function(t,e,o,r){var n=this.data.operators[t],i=n.internal.els[r].connectorArrows[e][o],s=i.offset(),a=this.element.offset(),l=(s.left-a.left)/this.positionRatio,c=parseInt(i.css("border-top-width")),p=(s.top-a.top-1)/this.positionRatio+parseInt(i.css("border-left-width"));return{x:l,width:c,y:p}},getLinkMainColor:function(t){var e=this.options.defaultLinkColor,o=this.data.links[t];return void 0!==o.color&&(e=o.color),e},setLinkMainColor:function(t,e){this.data.links[t].color=e,this.options.onAfterChange("link_change_main_color")},_drawLink:function(t){var e=this.data.links[t];void 0===e.internal&&(e.internal={}),e.internal.els={};var o=e.fromOperator,r=e.fromConnector,n=e.toOperator,i=e.toConnector,s=this._getSubConnectors(e),a=s[0],l=s[1],c=(this.getLinkMainColor(t),this.data.operators[o]),p=this.data.operators[n],h=c.internal.els.outputs.connectorSmallArrows[r][a],u=p.internal.els.inputs.connectorSmallArrows[i][l];e.internal.els.fromSmallConnector=h,e.internal.els.toSmallConnector=u;var d=document.createElementNS("http://www.w3.org/2000/svg","g");this.objs.layers.links[0].appendChild(d),e.internal.els.overallGroup=d;var f=document.createElementNS("http://www.w3.org/2000/svg","mask"),k="fc_mask_"+this.globalId+"_"+this.maskNum;this.maskNum++,f.setAttribute("id",k),d.appendChild(f);var v=document.createElementNS("http://www.w3.org/2000/svg","rect");v.setAttribute("x","0"),v.setAttribute("y","0"),v.setAttribute("width","100%"),v.setAttribute("height","100%"),v.setAttribute("stroke","none"),v.setAttribute("fill","white"),f.appendChild(v);var m=document.createElementNS("http://www.w3.org/2000/svg","polygon");m.setAttribute("stroke","none"),m.setAttribute("fill","black"),f.appendChild(m),e.internal.els.mask=m;var C=document.createElementNS("http://www.w3.org/2000/svg","g");C.setAttribute("class","flowchart-link"),C.setAttribute("data-link_id",t),d.appendChild(C);var w=document.createElementNS("http://www.w3.org/2000/svg","path");w.setAttribute("stroke-width",""+this.options.linkWidth),w.setAttribute("fill","none"),C.appendChild(w),e.internal.els.path=w;var O=document.createElementNS("http://www.w3.org/2000/svg","rect");O.setAttribute("stroke","none"),O.setAttribute("mask","url(#"+k+")"),C.appendChild(O),e.internal.els.rect=O,this._refreshLinkPositions(t),this.uncolorizeLink(t)},_getSubConnectors:function(t){var e=0;void 0!==t.fromSubConnector&&(e=t.fromSubConnector);var o=0;return void 0!==t.toSubConnector&&(o=t.toSubConnector),[e,o]},_refreshLinkPositions:function(t){var e=this.data.links[t],o=this._getSubConnectors(e),r=o[0],n=o[1],i=this.getConnectorPosition(e.fromOperator,e.fromConnector,r,"outputs"),s=this.getConnectorPosition(e.toOperator,e.toConnector,n,"inputs"),a=i.x,l=i.width,c=i.y,p=s.x,h=s.y;c+=this.options.linkVerticalDecal,h+=this.options.linkVerticalDecal;var u=this.options.distanceFromArrow;e.internal.els.mask.setAttribute("points",a+","+(c-l-u)+" "+(a+l+u)+","+c+" "+a+","+(c+l+u));var d=a+l+u,f=p+1,k=Math.min(100,Math.max(Math.abs(d-f)/2,Math.abs(c-h)));e.internal.els.path.setAttribute("d","M"+d+","+c+" C"+(a+l+u+k)+","+c+" "+(p-k)+","+h+" "+f+","+h),e.internal.els.rect.setAttribute("x",a),e.internal.els.rect.setAttribute("y",c-this.options.linkWidth/2),e.internal.els.rect.setAttribute("width",l+u+1),e.internal.els.rect.setAttribute("height",this.options.linkWidth)},getOperatorCompleteData:function(t){void 0===t.internal&&(t.internal={}),this._refreshInternalProperties(t);var e=$.extend(!0,{},t.internal.properties);for(var o in e.inputs)e.inputs.hasOwnProperty(o)&&null==e.inputs[o]&&delete e.inputs[o];for(var r in e.outputs)e.outputs.hasOwnProperty(r)&&null==e.outputs[r]&&delete e.outputs[r];return void 0===e.class&&(e.class=this.options.defaultOperatorClass),e},_getOperatorFullElement:function(t){function e(t,e,o,r){var n=$('<div class="flowchart-operator-connector-set"></div>');n.data("connector_type",r),n.appendTo(o),c[r].connectorArrows[t]=[],c[r].connectorSmallArrows[t]=[],c[r].connectors[t]=[],c[r].connectorSets[t]=n,l._createSubConnector(t,e,c,r)}var o=this.getOperatorCompleteData(t),r=$('<div class="flowchart-operator"></div>');r.addClass(o.class);var n=$('<div class="flowchart-operator-title"></div>');n.html(o.title),n.appendTo(r);var i=$('<div class="flowchart-operator-inputs-outputs"></div>');i.appendTo(r);var s=$('<div class="flowchart-operator-inputs"></div>');s.appendTo(i);var a=$('<div class="flowchart-operator-outputs"></div>');a.appendTo(i);var l=this,c={operator:r,title:n,inputs:{connectorSets:{},connectors:{},connectorArrows:{},connectorSmallArrows:{}},outputs:{connectorSets:{},connectors:{},connectorArrows:{},connectorSmallArrows:{}}};for(var p in o.inputs)o.inputs.hasOwnProperty(p)&&e(p,o.inputs[p],s,"inputs");for(var h in o.outputs)o.outputs.hasOwnProperty(h)&&e(h,o.outputs[h],a,"outputs");return c},_createSubConnector:function(t,e,o,r){var n=o[r].connectorSets[t],i=o[r].connectors[t].length,s=$('<div class="flowchart-operator-connector"></div>');s.appendTo(n),s.data("connector",t),s.data("sub_connector",i);var a=$('<div class="flowchart-operator-connector-label"></div>');a.text(e.label.replace("(:i)",i+1)),a.appendTo(s);var l=$('<div class="flowchart-operator-connector-arrow"></div>');l.appendTo(s);var c=$('<div class="flowchart-operator-connector-small-arrow"></div>');c.appendTo(s),o[r].connectors[t].push(s),o[r].connectorArrows[t].push(l),o[r].connectorSmallArrows[t].push(c)},getOperatorElement:function(t){var e=this._getOperatorFullElement(t);return e.operator},addOperator:function(t){for(;void 0!==this.data.operators[this.operatorNum];)this.operatorNum++;return this.createOperator(this.operatorNum,t),this.operatorNum},createOperator:function(t,e){function o(t,o){e.top=o.top,e.left=o.left;for(var r in i.data.links)if(i.data.links.hasOwnProperty(r)){var n=i.data.links[r];(n.fromOperator==t||n.toOperator==t)&&i._refreshLinkPositions(r)}}e.internal={},this._refreshInternalProperties(e);var r=this._getOperatorFullElement(e);if(!this.options.onOperatorCreate(t,e,r))return!1;var n=this.options.grid;n&&(e.top=Math.round(e.top/n)*n,e.left=Math.round(e.left/n)*n),r.operator.appendTo(this.objs.layers.operators),r.operator.css({top:e.top,left:e.left}),r.operator.data("operator_id",t),this.data.operators[t]=e,this.data.operators[t].internal.els=r,t==this.selectedOperatorId&&this._addSelectedClass(t);var i=this;if(this.options.canUserMoveOperators){var s,a;r.operator.draggable({containment:e.internal.properties.uncontained?!1:this.element,handle:".flowchart-operator-title",start:function(t){if(null!=i.lastOutputConnectorClicked)return void t.preventDefault();var e=i.element.offset();s=(t.pageX-e.left)/i.positionRatio-parseInt($(t.target).css("left")),a=(t.pageY-e.top)/i.positionRatio-parseInt($(t.target).css("top"))},drag:function(t,n){if(i.options.grid){var l=i.options.grid,c=i.element.offset();if(n.position.left=Math.round(((t.pageX-c.left)/i.positionRatio-s)/l)*l,n.position.top=Math.round(((t.pageY-c.top)/i.positionRatio-a)/l)*l,!e.internal.properties.uncontained){var p=$(this);n.position.left=Math.min(Math.max(n.position.left,0),i.element.width()-p.outerWidth()),n.position.top=Math.min(Math.max(n.position.top,0),i.element.height()-p.outerHeight())}n.offset.left=Math.round(n.position.left+c.left),n.offset.top=Math.round(n.position.top+c.top),r.operator.css({left:n.position.left,top:n.position.top})}o($(this).data("operator_id"),n.position)},stop:function(t,e){i._unsetTemporaryLink();var n=$(this).data("operator_id");o(n,e.position),r.operator.css({height:"auto"}),i.options.onOperatorMoved(n,e.position),i.options.onAfterChange("operator_moved")}})}this.options.onAfterChange("operator_create")},_connectorClicked:function(t,e,o,r){if("outputs"==r){this._restoreGrantedConnectorsColor();{new Date}this.lastOutputConnectorClicked={operator:t,connector:e,subConnector:o,grantedConnectors:this._getGrantedConnectors(t,e)},this.objs.layers.temporaryLink.show();var n=this.getConnectorPosition(t,e,o,r),i=n.x+n.width,s=n.y;this.objs.temporaryLink.setAttribute("x1",""+i),this.objs.temporaryLink.setAttribute("y1",""+s),this._mousemove(i,s),this._colorizeGrantedConnectors()}if("inputs"==r&&null!=this.lastOutputConnectorClicked){var a={fromOperator:this.lastOutputConnectorClicked.operator,fromConnector:this.lastOutputConnectorClicked.connector,fromSubConnector:this.lastOutputConnectorClicked.subConnector,toOperator:t,toConnector:e,toSubConnector:o};this._unsetTemporaryLink(),this.addLink(a)}},_getGrantedConnectors:function(t,e){var o=this.data.operators[t].type;if(void 0===o||0==this.data.linkRestrictions.length)return[];var r=this.data.linkRestrictions.filter(function(t){return o==t.fromOperatorType&&e==t.fromConnector}),n=[];for(var i in r){var s=r[i];for(var a in this.data.operators){var l=this.data.operators[a];if(l.type==s.toOperatorType){var c=l.internal.els.inputs.connectorArrows[s.toConnector];void 0!=c&&(c=c.map(function(t){return{els:t,oldColor:t.css("border-left-color")}}),n.push({color:void 0===s.color?this.options.defaultLinkColor:s.color,arrows:c}))}}}return n},_colorizeGrantedConnectors:function(){if(null!=this.lastOutputConnectorClicked){var t=this.lastOutputConnectorClicked.grantedConnectors;t.forEach(function(t){t.arrows.forEach(function(e){e.els.css("border-left-color",t.color)})})}},_restoreGrantedConnectorsColor:function(){if(null!=this.lastOutputConnectorClicked){var t=this.lastOutputConnectorClicked.grantedConnectors;t.forEach(function(t){t.arrows.forEach(function(t){t.els.css("border-left-color",t.oldColor)})})}},_unsetTemporaryLink:function(){this._restoreGrantedConnectorsColor(),this.lastOutputConnectorClicked=null,this.objs.layers.temporaryLink.hide()},_mousemove:function(t,e){null!=this.lastOutputConnectorClicked&&(this.objs.temporaryLink.setAttribute("x2",t),this.objs.temporaryLink.setAttribute("y2",e))},_click:function(t,e,o){var r=$(o.target);0==r.closest(".flowchart-operator-connector").length&&this._unsetTemporaryLink(),0==r.closest(".flowchart-operator").length&&this.unselectOperator(),0==r.closest(".flowchart-link").length&&this.unselectLink()},_removeSelectedClassOperators:function(){this.objs.layers.operators.find(".flowchart-operator").removeClass("selected")},unselectOperator:function(){if(null!=this.selectedOperatorId){if(!this.options.onOperatorUnselect())return;this._removeSelectedClassOperators(),this.selectedOperatorId=null}},_addSelectedClass:function(t){this.data.operators[t].internal.els.operator.addClass("selected")},selectOperator:function(t){this.options.onOperatorSelect(t)&&(this.unselectLink(),this._removeSelectedClassOperators(),this._addSelectedClass(t),this.selectedOperatorId=t)},getSelectedOperatorId:function(){return this.selectedOperatorId},getSelectedLinkId:function(){return this.selectedLinkId},_shadeColor:function(t,e){var o=parseInt(t.slice(1),16),r=0>e?0:255,n=0>e?-1*e:e,i=o>>16,s=o>>8&255,a=255&o;return"#"+(16777216+65536*(Math.round((r-i)*n)+i)+256*(Math.round((r-s)*n)+s)+(Math.round((r-a)*n)+a)).toString(16).slice(1)},colorizeLink:function(t,e){var o=this.data.links[t];o.internal.els.path.setAttribute("stroke",e),o.internal.els.rect.setAttribute("fill",e),o.internal.els.fromSmallConnector.css("border-left-color",e),o.internal.els.toSmallConnector.css("border-left-color",e)},uncolorizeLink:function(t){this.colorizeLink(t,this.getLinkMainColor(t))},_connecterMouseOver:function(t){this.selectedLinkId!=t&&this.colorizeLink(t,this._shadeColor(this.getLinkMainColor(t),-.4))},_connecterMouseOut:function(t){this.selectedLinkId!=t&&this.uncolorizeLink(t)},unselectLink:function(){if(null!=this.selectedLinkId){if(!this.options.onLinkUnselect())return;this.uncolorizeLink(this.selectedLinkId,this.options.defaultSelectedLinkColor),this.selectedLinkId=null}},selectLink:function(t){this.unselectLink(),this.options.onLinkSelect(t)&&(this.unselectOperator(),this.selectedLinkId=t,this.colorizeLink(t,this.options.defaultSelectedLinkColor))},deleteOperator:function(t){this._deleteOperator(t,!1)},_deleteOperator:function(t,e){if(!this.options.onOperatorDelete(t,e))return!1;if(!e)for(var o in this.data.links)if(this.data.links.hasOwnProperty(o)){var r=this.data.links[o];(r.fromOperator==t||r.toOperator==t)&&this._deleteLink(o,!0)}e||t!=this.selectedOperatorId||this.unselectOperator(),this.data.operators[t].internal.els.operator.remove(),delete this.data.operators[t],this.options.onAfterChange("operator_delete")},deleteLink:function(t){this._deleteLink(t,!1)},_deleteLink:function(t,e){if(this.selectedLinkId==t&&this.unselectLink(),this.options.onLinkDelete(t,e)||e){this.colorizeLink(t,"transparent");var o=this.data.links[t],r=o.fromOperator,n=o.fromConnector,i=o.toOperator,s=o.toConnector;o.internal.els.overallGroup.remove(),delete this.data.links[t],this._cleanMultipleConnectors(r,n,"from"),this._cleanMultipleConnectors(i,s,"to"),this.options.onAfterChange("link_delete")}},_cleanMultipleConnectors:function(t,e,o){var r="from"==o?"outputs":"inputs";if(this.data.operators[t].properties[r][e].multiple){var n=-1,i=o+"Operator",s=o+"Connector",a=o+"SubConnector",l=this.data.operators[t].internal.els,c=l.connectors[e],p=c.length;for(var h in this.data.links)if(this.data.links.hasOwnProperty(h)){var u=this.data.links[h];u[i]==t&&u[s]==e&&n<u[a]&&(n=u[a])}for(var d=Math.min(p-n-2,p-1),f=0;d>f;f++)c[c.length-1].remove(),c.pop(),l.connectorArrows[e].pop(),l.connectorSmallArrows[e].pop()}},deleteSelected:function(){null!=this.selectedLinkId&&this.deleteLink(this.selectedLinkId),null!=this.selectedOperatorId&&this.deleteOperator(this.selectedOperatorId)},setPositionRatio:function(t){this.positionRatio=t},getPositionRatio:function(){return this.positionRatio},getData:function(){var t=["operators","links","linkRestrictions"],e={};e.operators=$.extend(!0,{},this.data.operators),e.links=$.extend(!0,{},this.data.links),e.linkRestrictions=$.extend(!0,[],this.data.linkRestrictions);for(var o in t)if(t.hasOwnProperty(o)){var r=t[o];for(var n in e[r])e[r].hasOwnProperty(n)&&delete e[r][n].internal}return e.operatorTypes=this.data.operatorTypes,e},setOperatorTitle:function(t,e){this.data.operators[t].internal.els.title.html(e),void 0===this.data.operators[t].properties&&(this.data.operators[t].properties={}),this.data.operators[t].properties.title=e,this._refreshInternalProperties(this.data.operators[t]),this.options.onAfterChange("operator_title_change")},getOperatorTitle:function(t){return this.data.operators[t].internal.properties.title},setOperatorData:function(t,e){var o=this.getOperatorCompleteData(e);for(var r in this.data.links)if(this.data.links.hasOwnProperty(r)){var n=this.data.links[r];(n.fromOperator==t&&void 0===o.outputs[n.fromConnector]||n.toOperator==t&&void 0===o.inputs[n.toConnector])&&this._deleteLink(r,!0)}this._deleteOperator(t,!0),this.createOperator(t,e),this.redrawLinksLayer(),this.options.onAfterChange("operator_data_change")},getOperatorData:function(t){var e=$.extend(!0,{},this.data.operators[t]);return delete e.internal,e},getOperatorFullProperties:function(t){if(void 0!==t.type){var e=this.data.operatorTypes[t.type],o={};return void 0!==t.properties&&(o=t.properties),$.extend({},e,o)}return t.properties},_refreshInternalProperties:function(t){t.internal.properties=this.getOperatorFullProperties(t)}})});